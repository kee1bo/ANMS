<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Dashboard Integration Test - ANMS</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="assets/css/app.css">
    <link rel="stylesheet" href="assets/css/dashboard.css">
    <link rel="stylesheet" href="assets/css/health-conditions.css">
    <link rel="stylesheet" href="assets/css/health-metrics.css">
    <link rel="stylesheet" href="assets/css/professional-modal.css">
</head>
<body>
    <div class="dashboard-container">
        <div class="dashboard-header">
            <h1><i class="fas fa-heartbeat"></i> Health Dashboard Integration Test</h1>
            <div class="header-actions">
                <button class="btn btn-primary" onclick="testHealthIntegration()">
                    <i class="fas fa-play"></i> Test Integration
                </button>
            </div>
        </div>

        <!-- Dashboard Statistics Cards -->
        <div class="dashboard-stats">
            <div class="stat-card">
                <div class="stat-icon health">
                    <i class="fas fa-heart"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value" id="health_score">--</div>
                    <div class="stat-label">Health Score</div>
                    <div class="stat-change" id="health-change">Loading...</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon checkup">
                    <i class="fas fa-calendar-check"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value" id="next_checkup">--</div>
                    <div class="stat-label">Days to Checkup</div>
                    <div class="stat-change" id="checkup-change">Loading...</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon pets">
                    <i class="fas fa-paw"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value" id="total_pets">--</div>
                    <div class="stat-label">Total Pets</div>
                    <div class="stat-change" id="pets-change">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Health Metrics Section -->
        <div class="dashboard-section">
            <div class="section-header">
                <h2><i class="fas fa-chart-line"></i> Health Metrics</h2>
                <button class="btn btn-outline" onclick="refreshHealthMetrics()">
                    <i class="fas fa-refresh"></i> Refresh
                </button>
            </div>
            
            <div class="health-metrics-grid">
                <div class="metric-card">
                    <div id="overall-health-score">
                        <div class="health-loading">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>Loading health score...</p>
                        </div>
                    </div>
                </div>
                
                <div class="metric-card">
                    <div id="health-alerts">
                        <div class="health-loading">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>Loading health alerts...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="health-metrics-grid">
                <div class="metric-card">
                    <div id="pet-health-scores">
                        <div class="health-loading">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>Loading pet scores...</p>
                        </div>
                    </div>
                </div>
                
                <div class="metric-card">
                    <div id="health-trends">
                        <div class="health-loading">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>Loading health trends...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Health Conditions Management -->
        <div class="dashboard-section">
            <div class="section-header">
                <h2><i class="fas fa-stethoscope"></i> Health Conditions</h2>
                <div class="section-actions">
                    <select id="pet-selector" onchange="loadHealthConditionsForPet()">
                        <option value="">Select a pet...</option>
                    </select>
                </div>
            </div>
            
            <div id="health-conditions-container">
                <div class="empty-state">
                    <i class="fas fa-paw"></i>
                    <p>Select a pet to view health conditions</p>
                </div>
            </div>
        </div>

        <!-- Test Results -->
        <div class="dashboard-section">
            <div class="section-header">
                <h2><i class="fas fa-clipboard-check"></i> Integration Test Results</h2>
            </div>
            
            <div id="test-results" class="test-results">
                <div class="test-info">
                    <i class="fas fa-info-circle"></i>
                    <p>Click "Test Integration" to verify health records integration with dashboard</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="assets/js/components/dashboard-statistics.js"></script>
    <script src="assets/js/components/health-metrics.js"></script>
    <script src="assets/js/components/health-conditions.js"></script>
    
    <script>
        let dashboardStats = null;
        let healthMetrics = null;
        let healthConditions = null;
        
        // Initialize components
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize dashboard statistics
            dashboardStats = new DashboardStatistics();
            window.dashboardStats = dashboardStats;
            
            // Initialize health metrics
            healthMetrics = new HealthMetrics();
            window.healthMetrics = healthMetrics;
            
            // Initialize health conditions (without pet ID initially)
            healthConditions = new HealthConditionsComponent('health-conditions-container');
            window.healthConditions = healthConditions;
            
            // Load pets for selector
            loadPetsForSelector();
            
            // Test integration automatically
            setTimeout(testHealthIntegration, 1000);
        });
        
        async function loadPetsForSelector() {
            try {
                const response = await fetch('/api/pets.php', {
                    credentials: 'same-origin'
                });
                const data = await response.json();
                
                const selector = document.getElementById('pet-selector');
                selector.innerHTML = '<option value="">Select a pet...</option>';
                
                if (data.success && data.pets) {
                    data.pets.forEach(pet => {
                        const option = document.createElement('option');
                        option.value = pet.id;
                        option.textContent = pet.name;
                        selector.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading pets:', error);
            }
        }
        
        function loadHealthConditionsForPet() {
            const petId = document.getElementById('pet-selector').value;
            if (petId && healthConditions) {
                healthConditions.setPetId(petId);
            }
        }
        
        function refreshHealthMetrics() {
            if (healthMetrics) {
                healthMetrics.refresh();
            }
            if (dashboardStats) {
                dashboardStats.refresh();
            }
        }
        
        async function testHealthIntegration() {
            const resultsContainer = document.getElementById('test-results');
            resultsContainer.innerHTML = '<div class="test-loading"><i class="fas fa-spinner fa-spin"></i> Running integration tests...</div>';
            
            const tests = [];
            
            // Test 1: Dashboard Statistics API
            try {
                const statsResponse = await fetch('/api/dashboard.php?action=stats', {
                    credentials: 'same-origin'
                });
                const statsData = await statsResponse.json();
                
                tests.push({
                    name: 'Dashboard Statistics API',
                    status: statsData.success ? 'pass' : 'fail',
                    details: statsData.success ? 'Successfully loaded dashboard statistics' : statsData.error,
                    data: statsData.stats
                });
            } catch (error) {
                tests.push({
                    name: 'Dashboard Statistics API',
                    status: 'fail',
                    details: error.message
                });
            }
            
            // Test 2: Health Metrics API
            try {
                const healthResponse = await fetch('/api/dashboard.php?action=health_metrics', {
                    credentials: 'same-origin'
                });
                const healthData = await healthResponse.json();
                
                tests.push({
                    name: 'Health Metrics API',
                    status: healthData.success ? 'pass' : 'fail',
                    details: healthData.success ? 'Successfully loaded health metrics' : healthData.error,
                    data: healthData.health_metrics
                });
            } catch (error) {
                tests.push({
                    name: 'Health Metrics API',
                    status: 'fail',
                    details: error.message
                });
            }
            
            // Test 3: Health Conditions API
            try {
                // First get a pet ID
                const petsResponse = await fetch('/api/pets.php', {
                    credentials: 'same-origin'
                });
                const petsData = await petsResponse.json();
                
                if (petsData.success && petsData.pets && petsData.pets.length > 0) {
                    const petId = petsData.pets[0].id;
                    const conditionsResponse = await fetch(`/api/health-conditions.php?pet_id=${petId}`, {
                        credentials: 'same-origin'
                    });
                    const conditionsData = await conditionsResponse.json();
                    
                    tests.push({
                        name: 'Health Conditions API',
                        status: conditionsData.success ? 'pass' : 'fail',
                        details: conditionsData.success ? `Loaded ${conditionsData.conditions.length} conditions` : conditionsData.error,
                        data: conditionsData.conditions
                    });
                } else {
                    tests.push({
                        name: 'Health Conditions API',
                        status: 'skip',
                        details: 'No pets available for testing'
                    });
                }
            } catch (error) {
                tests.push({
                    name: 'Health Conditions API',
                    status: 'fail',
                    details: error.message
                });
            }
            
            // Test 4: Component Integration
            const componentTests = [
                { name: 'Dashboard Statistics Component', component: window.dashboardStats },
                { name: 'Health Metrics Component', component: window.healthMetrics },
                { name: 'Health Conditions Component', component: window.healthConditions }
            ];
            
            componentTests.forEach(test => {
                tests.push({
                    name: test.name,
                    status: test.component ? 'pass' : 'fail',
                    details: test.component ? 'Component initialized successfully' : 'Component not found'
                });
            });
            
            // Display results
            displayTestResults(tests);
        }
        
        function displayTestResults(tests) {
            const resultsContainer = document.getElementById('test-results');
            const passCount = tests.filter(t => t.status === 'pass').length;
            const failCount = tests.filter(t => t.status === 'fail').length;
            const skipCount = tests.filter(t => t.status === 'skip').length;
            
            resultsContainer.innerHTML = `
                <div class="test-summary">
                    <div class="summary-item pass">
                        <i class="fas fa-check-circle"></i>
                        <span>${passCount} Passed</span>
                    </div>
                    <div class="summary-item fail">
                        <i class="fas fa-times-circle"></i>
                        <span>${failCount} Failed</span>
                    </div>
                    <div class="summary-item skip">
                        <i class="fas fa-minus-circle"></i>
                        <span>${skipCount} Skipped</span>
                    </div>
                </div>
                
                <div class="test-details">
                    ${tests.map(test => `
                        <div class="test-item ${test.status}">
                            <div class="test-header">
                                <i class="fas fa-${test.status === 'pass' ? 'check' : test.status === 'fail' ? 'times' : 'minus'}-circle"></i>
                                <span class="test-name">${test.name}</span>
                                <span class="test-status">${test.status.toUpperCase()}</span>
                            </div>
                            <div class="test-description">${test.details}</div>
                            ${test.data ? `
                                <div class="test-data">
                                    <details>
                                        <summary>View Data</summary>
                                        <pre>${JSON.stringify(test.data, null, 2)}</pre>
                                    </details>
                                </div>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        // Listen for health record updates
        window.addEventListener('healthRecordUpdated', function(event) {
            console.log('Health record updated:', event.detail);
            
            // Show notification
            const notification = document.createElement('div');
            notification.className = 'notification success';
            notification.innerHTML = `
                <i class="fas fa-check-circle"></i>
                <span>Health record updated - dashboard refreshing...</span>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        });
    </script>
    
    <style>
        .test-results {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .test-loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .test-info {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .test-summary {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .summary-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            border-radius: 6px;
            font-weight: 500;
        }
        
        .summary-item.pass {
            background: #d4edda;
            color: #155724;
        }
        
        .summary-item.fail {
            background: #f8d7da;
            color: #721c24;
        }
        
        .summary-item.skip {
            background: #fff3cd;
            color: #856404;
        }
        
        .test-item {
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid;
        }
        
        .test-item.pass {
            background: #f8fff9;
            border-left-color: #28a745;
        }
        
        .test-item.fail {
            background: #fff8f8;
            border-left-color: #dc3545;
        }
        
        .test-item.skip {
            background: #fffef8;
            border-left-color: #ffc107;
        }
        
        .test-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        
        .test-name {
            flex: 1;
            font-weight: 500;
        }
        
        .test-status {
            font-size: 12px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 4px;
            background: rgba(0,0,0,0.1);
        }
        
        .test-description {
            color: #666;
            font-size: 14px;
        }
        
        .test-data {
            margin-top: 10px;
        }
        
        .test-data pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .health-metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .metric-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 6px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .notification.success {
            background: #28a745;
        }
    </style>
</body>
</html>